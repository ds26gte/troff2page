.\" last modified 2015-03-20
.\" Dorai Sitaram
.
.\" don't load if not groff
.if !\n(.g .nx
.
.\" don't load more than once
.
.if d evallispsnippets .nx
.
.if !\n[.troff2page] \{\
.de evallispsnippets
.\" change this to suit the Common Lisp impl
.ds evallispsnippets:file \\*[AUXF].lisp
.sy touch \\*[evallispsnippets:file]
.sy if   test "$LISP" = clisp; then clisp \\*[evallispsnippets:file]; \
    elif test "$LISP" = clozure; then ccl -l \\*[evallispsnippets:file] -e '(ccl:quit)'; \
    elif test "$LISP" = cmu; then lisp -quiet -load \\*[evallispsnippets:file] -eval '(ext:quit)'; \
    elif test "$LISP" = ecl; then ecl -shell \\*[evallispsnippets:file]; \
    elif test "$LISP" = sbcl; then sbcl --noinform --load \\*[evallispsnippets:file] --eval '(sb-ext:quit)'; \
    elif test "$(uname -s)" = Linux -o "$(uname -s)" = SunOS; then sbcl --noinform --load \\*[evallispsnippets:file] --eval '(sb-ext:quit)'; \
    elif test "$(uname -s)" = Darwin; then ccl -l \\*[evallispsnippets:file] -e '(ccl:quit)'; \
    else clisp \\*[evallispsnippets:file]; \
    fi
..
.\}
.
.if '\*[AUXF]'' .ds AUXF .trofftemp
.
.nr eval4troff:already_setup 0
.
.de eval4troff:setup
.  if \\n[eval4troff:already_setup] .return
.  nr eval4troff:already_setup 1
.  if !\\n[.U] .return
.  evallispsnippets
.  nr eval4troff:count 0
.  open  eval4troff:port \\*[AUXF].lisp
.  write eval4troff:port (defvar *eval4troff-stdout* *standard-output*)
.  write eval4troff:port (defun eval4troff-preamble (f)
.  write eval4troff:port   (setq *standard-output*
.  write eval4troff:port     (open f :direction :output :if-exists :supersede)))
.  write eval4troff:port (defun eval4troff-postamble ()
.  eo
.  write eval4troff:port   (format t "\\\\c~%")
.  ec
.  write eval4troff:port   (format t ".ds eval4troff:status done~%")
.  write eval4troff:port   (close *standard-output*)
.  write eval4troff:port   (setq *standard-output* *eval4troff-stdout*))
..
.
.ds eval4troff:status try
.
.de eval
.  eval4troff:setup
.  nr eval4troff:count +1
.  ie !'\\*[eval4troff:status]'rerun' \{\
.    so \\*[AUXF]_lisp_\\n[eval4troff:count].tmp
.    if !'\\*[eval4troff:status]'done' .eval4troff:usage
.  \}
.  if !'\\*[eval4troff:status]'done' \[rh]eval\[lh]
.  eo
.  de eval4troff:text endeval
..
.
.de endeval
.  ec
.  if !\\n[.U] .return
.  write  eval4troff:port (eval4troff-preamble "\\*[AUXF]_lisp_\\n[eval4troff:count].tmp")
.  eo
.  writem eval4troff:port eval4troff:text
.  ec
.  write  eval4troff:port (eval4troff-postamble)
..
.
.de eval4troff:usage
.  ds eval4troff:status rerun
.  if !\\n[.troff2page] .tm Rerun groff with -U
..
.ig ##
(defrequest "evallispsnippets"
  (lambda ()
    (read-troff-line)
    (let ((f (concatenate 'string
                (funcall (gethash "AUXF" *string-table*))
                ".lisp")))
      (when (probe-file f) (load f)))))
.##
